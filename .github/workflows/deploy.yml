name: deploy-haloui-to-hostinger-sftp

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      # Install once at monorepo root
      - name: Install dependencies (root)
        run: |
          if [ -f package-lock.json ]; then npm ci; else npm install; fi

      # Build the UI lib first (if app imports @haloui/ui)
      - name: Build UI library (@haloui/ui)
        run: |
          if [ -d "packages/ui" ]; then
            npm --workspace packages/ui run build || echo "ui build skipped"
          fi

      # Build the React app (outputs to app/dist/)
      - name: Build HaloUI app
        run: npm --workspace app run build

      # Ensure SPA routing on Hostinger
      - name: Ensure .htaccess (SPA routing)
        run: |
          cat > app/dist/.htaccess << 'EOF'
          Options -MultiViews
          RewriteEngine On
          RewriteBase /
          RewriteCond %{REQUEST_FILENAME} -f [OR]
          RewriteCond %{REQUEST_FILENAME} -d
          RewriteRule ^ - [L]
          RewriteRule . /index.html [L]
          EOF

      - name: List build output
        run: ls -la app/dist && du -sh app/dist || true

      # ---- SFTP DEPLOY (SSH, port 22) ----
      - name: SFTP Deploy
        uses: wlixcc/SFTP-Deploy-Action@v1.2.4
        with:
          server:     ${{ secrets.SSH_HOST }}              # haloui.bydeb.in (NO https://)
          port:       ${{ secrets.SSH_PORT }}              # 22
          username:   ${{ secrets.SSH_USERNAME }}
          # use ONE of the following:
          password:   ${{ secrets.SSH_PASSWORD }}
          # ssh_private_key: ${{ secrets.SSH_PRIVATE_KEY }}

          local_path: "app/dist/*"
          # subdomain document root on Hostinger:
           remote_path: "public_html/"

          sftp_only: true
          delete_remote_files: true
          exclude: ".git*,node_modules,*.map,.DS_Store"
