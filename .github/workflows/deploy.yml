name: deploy-haloui-to-hostinger-sftp
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install deps (root)
        run: |
          if [ -f package-lock.json ]; then npm ci; else npm install; fi

      - name: Build UI lib
        run: |
          if [ -d "packages/ui" ]; then
            npm --workspace packages/ui run build || echo "ui build skipped"
          fi

      - name: Build app
        run: npm --workspace app run build

      - name: Ensure .htaccess (SPA)
        run: |
          cat > app/dist/.htaccess << 'EOF'
          Options -MultiViews
          RewriteEngine On
          RewriteBase /
          RewriteCond %{REQUEST_FILENAME} -f [OR]
          RewriteCond %{REQUEST_FILENAME} -d
          RewriteRule ^ - [L]
          RewriteRule . /index.html [L]
          EOF

      # 1) (optional) sanity: show current server dirs
      - name: SSH list target dir (sanity)
        uses: appleboy/ssh-action@v1.2.0
        with:
          host:     ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}   # or use key: 'key: ${{ secrets.SSH_PRIVATE_KEY }}'
          port:     ${{ secrets.SSH_PORT || 22 }}
          script: |
            pwd
            ls -la
            # create the subdomain dir if missing (adjust ONE of these)
            mkdir -p domains/haloui.bydeb.in/public_html
            # mkdir -p public_html

      # 2) SFTP upload to an existing directory (NO * at the end)
      - name: SFTP Deploy
        uses: wlixcc/SFTP-Deploy-Action@v1.2.4
        with:
          server:     ${{ secrets.SSH_HOST }}
          port:       ${{ secrets.SSH_PORT || 22 }}
          username:   ${{ secrets.SSH_USERNAME }}
          password:   ${{ secrets.SSH_PASSWORD }}   # or: ssh_private_key: ${{ secrets.SSH_PRIVATE_KEY }}
          local_path: "app/dist/*"
          remote_path: "domains/haloui.bydeb.in/public_html/"   # or "public_html/"
          sftp_only: true
          delete_remote_files: true
          exclude: ".git*,node_modules,*.map,.DS_Store"
